version: "3"
services:
  gateway:
    container_name: gateway
    build: ./gateway/
    volumes:
      - ./data/gateway/html:/var/www/html
      - ./data/certs:/root/certs
      - ./data/logs/gateway:/var/log/nginx
      - ./gateway/snakeoil.conf:/etc/nginx/snippets/snakeoil.conf
      - ./gateway/default:/etc/nginx/sites-enabled/default
      - ./gateway/realip.conf:/etc/nginx/snippets/realip.conf
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf
    restart: always
    depends_on:
      - website
    ports:
      - "80:80"
      - "443:443"
    networks:
      internal:
        ipv4_address: 172.18.42.2
  tracker:
    container_name: tracker
    build: ./tracker/
    expose:
      - "80"
    ports:
      - "6880:6880"
      - "6969:6969"
    volumes:
      - ./tracker/config.conf:/config.conf
    restart: always
    networks:
      internal:
        ipv4_address: 172.18.42.5
      phpnet:
        ipv4_address: 172.18.43.5
  website:
    container_name: website
    build: ./website/
    depends_on:
      - php
    expose:
      - "80"
      - "443"
    volumes:
      - ./data/website:/var/www
      - ./data/logs/website:/var/log/nginx
      - ./website/default:/etc/nginx/sites-enabled/default
      - ./website/php-fpm.conf:/etc/nginx/snippets/php-fpm.conf
    restart: always
    networks:
      internal:
        ipv4_address: 172.18.42.3
      phpnet:
        ipv4_address: 172.18.43.3
  php:
    container_name: php
    build: ./php/
    volumes:
      - ./data/website:/var/www
    expose:
      - "9000"
    restart: always
    networks:
      phpnet:
        ipv4_address: 172.18.43.2
#  archive:
#    container_name: archive
#    build: ./archive/
#    volumes:
#      - ./data/archive/:/var/www/
#      - ./archive/default:/etc/nginx/sites-enabled/default
#      - ./data/logs/archive/:/var/log/nginx/
#    restart: always
#    expose:
#      - "80"
#      - "443"
#    networks:
#      archive:
#        ipv4_address: 172.18.44.2
#  archive_mirrorbits:
#    container_name: archive_mirrorbits
#    build: ./archive_mirrorbits/
#    volumes:
#      - ./data/archive/:/var/www/
#      - ./archive_mirrorbits/mirrorbits.conf:/etc/mirrorbits.conf
#    restart: always
#    expose:
#      - "9000"
#    networks:
#      archive:
#        ipv4_address: 172.18.44.3
#  archive_rsync:
#    container_name: archive_rsync
#    build: ./archive_utils/
#    volumes:
#      - ./data/archive/:/var/www/
#    restart: always
#    ports:
#      - "873:873"
#    networks:
#      archive:
#        ipv4_address: 172.18.44.3
#  archive_updater:
#    container_name: archive_updater
#    build: ./archive_utils/
#    volumes:
#      - ./data/archive/:/var/www/
#    restart: always
#    networks:
#      archive:
#        ipv4_address: 172.18.44.4
#  redis:
#    container_name: redis
#    build: ./redis/
#    volumes:
#      - ./data/redis/:/var/lib/redis/
#      - ./data/logs/redis/:/var/log/redis/
#    restart: always
#    expose:
#      - "6379"
#    networks:
#        archive:
#          ipv4_address: 172.18.44.5
#  dnsdist:
#    container_name: dnsdist
#    build: ./geodns/dnsdist/
#    restart: always
#    depends_on:
#      - pdns
#      - recursor
#      - gateway
#    ports:
#      - "53:53"
#    expose:
#      - "53"
#    volumes:
#      - ./geodns/dnsdist.conf:/etc/dnsdist/dnsdist.conf
#    networks:
#      dnsnet:
#        ipv4_address: 172.18.53.2
#  pdns:
#    container_name: pdns
#    build: ./geodns/pdns/
#    restart: always
#    expose:
#      - "8053"
#    volumes:
#      - ./geodns/pdns.conf:/etc/powerdns/pdns.conf
#      - ./geodns/pdns.service:/lib/systemd/system/pdns.service
#      - ./geodns/geoip.conf:/etc/powerdns/pdns.d/geoip.conf
#      - ./geodns/geo.yml:/etc/powerdns/geo.yml
#    networks:
#      dnsnet:
#        ipv4_address: 172.18.53.3
#  recursor:
#    container_name: recursor
#    build: ./geodns/recursor/
#    restart: always
#    expose:
#      - "8153"
#    volumes:
#      - ./geodns/recursor.conf:/etc/powerdns/recursor.conf
#      - ./geodns/pdns-recursor.service:/lib/systemd/system/pdns-recursor.service
#      - ./geodns/root.hints:/etc/powerdns/root.hints
#    networks:
#      dnsnet:
#        ipv4_address: 172.18.53.4



networks:
  internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.42.0/24
#  archive:
#    driver: bridge
#    ipam:
#      config:
#        - subnet: 172.18.44.0/24
  phpnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.43.0/24
#  dnsnet:
#    driver: bridge
#    ipam:
#      config:
#        - subnet: 172.18.53.0/24
