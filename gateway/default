# redirect to https
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    return 301 https://$host$request_uri;
}

# redirect invalid websites
server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        include snippets/snakeoil.conf;
        include snippets/realip.conf;
        server_name _;
        return 301 https://www.parrot.sh;
}

# redirect old website
server {
        listen 443 ssl;
        listen [::]:443 ssl;
        include snippets/snakeoil.conf;
        include snippets/realip.conf;
        server_name parrotsec.org www.parrotsec.org;
        return 301 https://www.parrot.sh$request_uri;
}

# website
server {
        listen 443 ssl;
        listen [::]:443 ssl;
        include snippets/snakeoil.conf;
        include snippets/realip.conf;
        root /var/www/html;
        index index.php index.html;

        server_name blog.* docs.* documentation.* start.* www.* vscodium.com *.vscodium.com;

        location / {
                proxy_pass http://172.18.42.3;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
        }

        location ~* \.(css|js|png|gif|jpg|sass|eot|svg|ttf|woff|woff2|html)$ {
                proxy_pass http://172.18.42.3;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                expires max;
                add_header Pragma public;
                add_header Cache-Control "public";
        }

        #location ~ /\.ht {
        #       deny all;
        #}

}


# static
server {
        listen 443 ssl;
        listen [::]:443 ssl;
        include snippets/snakeoil.conf;
        include snippets/realip.conf;

        root /var/www/static;
        index index.html;
        server_name static.* director.geo.* geo.* cdn.* gibson1.infra.parrot.sh;
        location / {
                autoindex on;
                try_files $uri $uri/ =404;
                expires max;
                add_header Pragma public;
                add_header Cache-Control "public";
        }
}

# community
server {
        listen 443 ssl;
        listen [::]:443 ssl;
        include snippets/snakeoil.conf;
        include snippets/realip.conf;

        server_name community.* cdn-community.*;

        http2_idle_timeout 5m;

        location / {
                proxy_pass https://172.18.42.1:8443;
                proxy_set_header Host community.parrotsec.org;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Proto https;
                proxy_buffers 64 16384k;
                proxy_buffer_size 512k;
        }

        location ~* \.(css|js|png|gif|jpg|sass|eot|svg|ttf|woff|woff2)$ {
                proxy_pass https://172.18.42.1:8443;
                proxy_set_header Host community.parrotsec.org;
                proxy_set_header X-Real-IP $remote_addr;
                expires max;
                add_header Pragma public;
                add_header Cache-Control "public";
        }
}
